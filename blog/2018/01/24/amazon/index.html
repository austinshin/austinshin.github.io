
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>backazon - a recommendation service  - Austin Shin</title>
	<meta name="author" content="Austin Shin">

	
	<meta name="description" content="Backazon - a Recommendation Service Project summary:
I worked on a project with a team building a backend API services system dealing with millions &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Austin Shin" type="application/atom+xml">
	
	<link rel="canonical" href="http://austinshin.github.io/blog/2018/01/24/amazon/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("shinaustin@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/"><h1>Austin Shin</h1></a></li>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/blog/categories/sideproject">Side Projects</a></li>
    <li><a href="/about">Achievements</a></li>
    <li><a href="https://github.com/austinshin">Github</a></li>
    <li><a href="https://instagram.com/link115">Instagram</a></li>
    <li><a href="https://twitter.com/link115_">Twitter</a></li>
    <li><a href="https://www.youtube.com/playlist?list=PLfdaAogiAw-igfBt_uIBuO3uewbsPENzw">Playlist</a></li>
    <li><a href="/blog/archives">Archives</a></li>
  </ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:shinaustin@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/link115_" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/austinshin" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Backazon - a Recommendation Service</h1>
	<div class="entry-content" itemprop="articleBody"><p>Project summary:
I worked on a project with a team building a backend API services system dealing with millions of data. It was to answer a business question: “Which recommendation algorithm collaboration or content-filtered, generates more sales/revenue in Amazon?”</p>

<!-- more -->


<p>Collaborative filtering is based on user-user comparison from previously viewed/bought/favorited items.</p>

<p>Content filtering is based on item-item comparison from past browsing history</p>

<p>A lot of initial planning was done as it was going to be a service integrated with 4 other services.</p>

<h2>First major decision was to decide which database to use.</h2>

<p>MYSQL vs NOSQL.</p>

<p>Should I use Postgres or Mongo or MySQL?</p>

<p>Should I use a giant big table or should I use many different entries?</p>

<p>Should I use graphQL as a querying system?</p>

<p>All of these interesting databases I was reading about sounded great until I found one: neo4j.</p>

<p>I decided to use NEO4j as a database because it was a graph database. The service I was building was only really interested in the relationships between a user and a product. Therefore, a database system that focused on relationships (a graph) which can create ‘nodes’ as users/products and ‘edges’ relationships made the most sense. This meant data modeling was clearer, data querying was more efficient vs doing multiple ‘joins’ on a table trying to create a relationship, and the database abstracted away all the complicated things. Likewise, visualization from neo4j was a plus.</p>

<p>What you sketch out on a whiteboard can be directly translated into neo4j. This was one of the best points of it.</p>

<h2>Data generation of 40million</h2>

<p>I created a data generation script. Some of the problems I ran into were creating millions of data which was solved by generating data in batches of CSV files (JSON could have worked as well). Inserting data was done the same way.</p>

<p>A total of 10 million users, 3000 top trending product nodes were created.</p>

<p>A total of 50 million relationship types (click, wishlist, view, purchased, car) were created.</p>

<h2>Testing endpoints.</h2>

<p>Eventually I ended up implementing &lsquo;fake endpoints&rsquo; to the other services. I used my fake data to help test these results. One thing I noticed was the long query time (314ms) to return a recommended item list. I wanted to go for a much more faster, realistic speed especially when it comes to serving up millions of users at once. I wanted to aim for something below 200ms.</p>

<p>I looked up optimization methods and a couple of big words popped out:</p>

<p><strong>load balancing, horizontal/vertical scaling, sharding, caching, message bus (queues)</strong></p>

<p>In order to speed up the query time, I decided to use Redis a key-value caching database. By caching values, it optimized lookups on the most popular items to be pretty much instantaneous. The results of using redis vs not using it was night and day.</p>

<p>The end result was a 100x faster querying system going from 300ms -> 3ms.</p>

<p>The idea was to create a system where in the background at night the microservice would periodically update the cache for the most popular users. If the site was serving up someone who didn&rsquo;t come often, it&rsquo;d return a recommended list after calculations.</p>

<p><img src="https://puu.sh/zg611/931730d3d1.png" alt="stress test results" /></p>

<p>My benchmark query was 1ms. RPS: 1800~
An average query to receive some info about a user was 12ms. RPS: 1300~
An average query to receive some info about a product was 9ms. RPS: 1800~
An average query to recommend a new product was about 350ms. RPS: 44~
An average query to recommend a new product CACHED was about 6ms. RPS: 2300~</p>

<hr />

<p>An interesting thing that eventually came up was how to deploy a microservice like this to the &lsquo;real world&rsquo;.</p>

<p>One of the most popular methods was to use AWS EC2 and Docker in conjunction. A lot of research was done into this and a lot of cool things were learned. This was probably my favorite (and slightly painful) part of the project.</p>

<p>Basically you could use EC2 as a cloud computer along with Docker as a vm in order to spin up multiple instances of a certain app. It could be a db, or even my api app I created. The ability to create multiple same instances meant one could load balance. If you create multiple dbs, you could potentially shard data. All of this fell under the category of horizontally scaling ~ spreading out the work done over many instances.</p>

<p>AWS and docker was tricky to learn at first, but eventually I learned it and got my app to deploy.</p>

<h2>Below is a list of randomized notes I took while doing the project</h2>

<p>Using Redis:</p>

<p>Some questions I asked myself while thinking about and hearing about redis are&hellip;</p>

<p>What is the point of Redis?</p>

<p>What is caching?</p>

<p>What does it mean to store it in memory?</p>

<p>What makes it so much faster than storing it in a MYSQL or NOSQL database?</p>

<p>What are the tradeoffs of storing it in cache?</p>

<p>How does it work?</p>

<p>How can I use it properly?</p>

<p>How can I optimize it even more?</p>

<p>As you increase database size, so does your memory size.
<strong>useful commands</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redis-server</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redis-cli</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FLUSHDB</span></code></pre></td></tr></table></div></figure>


<p>Using Neo4J:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ neo4j-client -u neo4j localhost</span></code></pre></td></tr></table></div></figure>


<p>localhost:7474</p>

<p>important queries:</p>

<p>&ldquo; FOR GETTING ALL RELATIONSHIPS &rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MATCH (a:USER)-[relatedTo]-(b) RETURN a.name, b.name, Type(relatedTo), relatedTo;</span></code></pre></td></tr></table></div></figure>


<p>&ldquo; FOR GETTING RECOMMENDED LIST FOR A SPECIFIC USER ID BASED ON WHAT OTHER USERS HAVE PURCHASED.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"MATCH (a:USER {user_id:''})-[:RELATION]-&gt;(m)&lt;-[:RELATION]-(product),(product)-[:RELATION]-&gt;(m2) RETURN m2.name AS Recommended, count(*) AS Strength ORDER BY Strength DESC LIMIT 5;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE INDEX ON :Label(name);</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>USING PERIODIC COMMIT 500
</span><span class='line'>LOAD CSV WITH HEADERS FROM "file:///events1.csv" as input
</span><span class='line'>MATCH (user:USER  {user_id: input.user_id}), (product:PRODUCT {product_id: input.product_id})
</span><span class='line'>CREATE (user)-[:RELATION { type: input.event_type }]-&gt;(product);</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MATCH (n:Label {name: 'Kadin Mitchell'}),
</span><span class='line'>(n)-[rel:RELATION]-&gt;(follower)
</span><span class='line'>where rel.type = 'click'
</span><span class='line'>return n, follower;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MATCH (:USER {name: 'Kadin Mitchell'})-[r]-()
</span><span class='line'>RETURN r</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>MATCH (n:Label {name: 'b'}),
</span><span class='line'>(n)-[rel:RELATION]-&gt;(follower)
</span><span class='line'>where rel.type = 'FOLLOWS'
</span><span class='line'>return n, follower</span></code></pre></td></tr></table></div></figure>


<p>Dokku
EC2
Docker
MOCHA CHAI HTTP REQUESTS (TESTS)</p>

<p>feb 1:
<a href="https://gist.github.com/austinshin/7883fe17f990fbd69425ba7fe0e2e525">https://gist.github.com/austinshin/7883fe17f990fbd69425ba7fe0e2e525</a>
-read up on ec2/aws
-docker
-set up endpoints
-set up integration between redis (caching) and neo4j
-indexing and constraints (understand what it does in neo4j)</p>

<p>things to work on:
- set up redis fetch fake request
- do a siege test on each of the endpoints.</p>

<h2>- upload to docker and try to optimize.</h2>

<p>If our client is requesting something for live time data do we need to have a SQS / message bus system set up to handle it one by one?
my guess is no!</p>

<p>QUERY SYSTEM DATA WITH ONLY DATABASE:
<a href="https://puu.sh/zfpbl/066bf7d7cb.png">https://puu.sh/zfpbl/066bf7d7cb.png</a>
need to add &ldquo;write to product&rdquo; and &ldquo;write to user&rdquo;?
 and &ldquo;create a relationship?&rdquo;
 can these just be the same thigns over and over again so we can delete it ?</p>

<p>made sure to test incrementally
to make sure everything works</p>

<p>store in redis as {user_id: recommendedList}?
or&hellip; store as index = user_id : recommendedList?</p>

<p>takes about 5 seconds to query and cache 10 results
takes about 12 seconds to query and cache 100 reuslts
takes about 30 seconds to query and cache 1000 results</p>

<p>takes 3ms to query cached recommendations.
takes 300ms to query neo4j to calculate a recommendation.</p>

<p><a href="https://puu.sh/zg611/931730d3d1.png">https://puu.sh/zg611/931730d3d1.png</a></p>

<p>TODO:
1. change content filter method to compare to products.
2. change redis key:value schema (to be {user_id: [recommended list]})
3. add a cronjob to update every so often&hellip;
4. add logic to &ldquo;check if user/product exists. if they don&rsquo;t, MERGE them into neo4j, create a relationship&rdquo; (use a queue system or something to do this? not sure&hellip;)
^ should be able to handle a good amount of new users.
5. start working on docker and getting that set up.</p>

<p>Feb 5:
refactored redis to use hash table instead of arrays~ because I needed to keep track of userid
added mocha and chai testing for TDD (there&rsquo;s a nice article about BDD, unit tests, and TDD)
created video for thesis midpoint project
<a href="https://joshldavis.com/2013/05/27/difference-between-tdd-and-bdd/">https://joshldavis.com/2013/05/27/difference-between-tdd-and-bdd/</a></p>

<p>tomorrow&rsquo;s goals:
new relic
docker
cronjob endpoints to other two services.
read up on 10k rps&hellip;
set up a messagebus queue if i need it?
unit test endpoints</p>

<p>deployment to EC2</p>

<p>work on collaborative recommendation algorithm</p>

<hr />

<p>ec2 related stuff:
<a href="https://medium.com/@andrewcbass/install-redis-v3-2-on-aws-ec2-instance-93259d40a3ce">https://medium.com/@andrewcbass/install-redis-v3-2-on-aws-ec2-instance-93259d40a3ce</a>
ssh -i ~/.ssh/redis.pem ec2-user</p>

<p>docker stuff</p>

<ol>
<li>make a dockerfile</li>
<li>add all the commands</li>
<li>docker build -t austinshin/recservice .</li>
<li>docker run -d -p 49160:3000 -v $(pwd):/src/app &ndash;name thesis austinshin/recservice</li>
<li>to remove&hellip;</li>
<li>stop the docker container</li>
<li>docker rm containername</li>
<li>docker rmi imagename
CALL dbms.changePassword(&lsquo;123&rsquo;);</li>
</ol>


<p>docker exec -t -i container_name /bin/bash</p>

<p>docker-machine ls
docker-machine start</p>

<p>docker exec -t -i recommendationservice_neo4j_1 /bin/bash
eval &ldquo;$(docker-machine env default)&rdquo;</p>

<hr />

<p>set up queue and then have it point to multiple databases.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ecs-cli up
</span><span class='line'>ecs-cli up --keypair app --capability-iam --size 3 --instance-type t2.medium --force
</span><span class='line'>ecs-cli compose --file docker-compose.yml up
</span><span class='line'>change security group to allow TCP 22 (with ur ip so you can ssh in)
</span><span class='line'>
</span><span class='line'>ssh -i ~/desktop/app.pem ec2-user@54.215.227.138
</span><span class='line'>sudo yum update
</span><span class='line'>sudo yum install -y docker
</span><span class='line'>sudo service docker start
</span><span class='line'>sudo usermod -a -G docker ec2-user
</span><span class='line'>docker info
</span><span class='line'>ecs-cli down</span></code></pre></td></tr></table></div></figure>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="false"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2018

    Austin Shin


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
